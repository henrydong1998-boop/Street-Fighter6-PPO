from wincam import DXCamera
import cv2
import time
import numpy as np

def extract_health_info(bgr_frame: np.ndarray) -> tuple[float, float]:
    start_time = time.time()
    HSV_TOLERANCE = 10
    HEALTH_BAR_Y = 91
    MIN_X_ACTOR, MAX_X_ACTOR = (236, 1127)
    MIN_HSV_ACTOR = np.array([339 - HSV_TOLERANCE, 87 - HSV_TOLERANCE, 49 - HSV_TOLERANCE])
    MAX_HSV_ACTOR = np.array([341 + HSV_TOLERANCE, 100, 86 + HSV_TOLERANCE])
    MIN_X_OPPONENT, MAX_X_OPPONENT = (1431, 2317)
    MIN_HSV_OPPONENT = np.array([207 + HSV_TOLERANCE, 83 - HSV_TOLERANCE, 55 - HSV_TOLERANCE])
    MAX_HSV_OPPONENT = np.array([224 + HSV_TOLERANCE, 93 + 7, 73 + HSV_TOLERANCE])

    hsv_frame = cv2.cvtColor(bgr_frame, cv2.COLOR_BGR2HSV)
    actor_health_bar = hsv_frame[HEALTH_BAR_Y: HEALTH_BAR_Y + 1, MIN_X_ACTOR : MAX_X_ACTOR, : ]
    opponent_health_bar = hsv_frame[HEALTH_BAR_Y: HEALTH_BAR_Y + 1, MIN_X_OPPONENT : MAX_X_OPPONENT, : ]
    # print(f"actor health bar has type{type(actor_health_bar)}, and shape {actor_health_bar.shape}")
    # print(f"opponent health bar has type{type(opponent_health_bar)}, and shape {opponent_health_bar.shape}")
    actor_health_mask = cv2.inRange(actor_health_bar, MIN_HSV_ACTOR, MAX_HSV_ACTOR)
    opponent_health_mask = cv2.inRange(opponent_health_bar, MIN_HSV_OPPONENT, MAX_HSV_OPPONENT)
    actor_healthbar_len = actor_health_mask.shape[1]
    opponent_healthbar_len = opponent_health_mask.shape[1]
    actor_health = np.count_nonzero(actor_health_mask)
    opponent_health = np.count_nonzero(opponent_health_mask)
    end_time = time.time()
    print(f"actor health is {actor_health}, and oppnent health is {opponent_health}")
    # print(f"actor health mask is of type{type(actor_health_mask)}, and shape {actor_health_mask.shape}")
    # print(f"opponent health mask is of type {type(opponent_health_mask)}, and shape {opponent_health_mask.shape}")
    print(f"function took {end_time - start_time} seconds")
    return (0, 0)

# camera = DXCamera(0, 32, 1920, 1080, fps=30)

if __name__ == "__main__":
    time_begin = time.time()
    counter = 0
    with DXCamera(0, 32, 1920, 1080, fps=30) as camera:
        while True:
            frame, _ = camera.get_bgr_frame()
            result = extract_health_info(frame)
            # time.sleep(1)
            # cv2.imwrite(f"captureimg{counter}.png", frame)
            counter += 1
            time_end = time.time()
            print(f"calling took {time_end - time_begin} seconds")
            time_begin = time_end